# Исправление проблемы с произвольным закрашиванием ячеек в Google Sheets

## Проблема

В Google Sheets при закрашивании выполненных семей произвольно закрашивались ячейки других семей. Это происходило из-за неточного алгоритма поиска и сопоставления семей в таблице.

## Причины проблемы

1. **Неточный поиск по ФИО**: Использовался простой поиск подстроки, который мог находить частичные совпадения в неподходящих ячейках
2. **Неправильное определение столбца с именем**: Алгоритм просто искал первое вхождение части имени, не учитывая контекст
3. **Закрашивание всей строки**: При нахождении совпадения закрашивалась вся строка, включая ячейки, относящиеся к другим членам семьи

## Решение

### 1. Улучшенный алгоритм сопоставления

Добавлен метод `_calculate_match_score`, который:
- Разбивает имя на части (фамилия, имя, отчество)
- Игнорирует короткие слова (меньше 3 символов)
- Вычисляет коэффициент совпадения как количество найденных частей / общее количество частей
- Повышает оценку при полном совпадении всех частей имени

### 2. Уточненное определение столбца с именем

Метод `_find_name_column_index` теперь:
- Сначала ищет полное совпадение имени в ячейке
- Если полное совпадение не найдено, ищет частичные совпадения по нескольким частям
- Требует как минимум 2 совпадения для уверенного сопоставления
- В крайнем случае ищет хотя бы одно достоверное совпадение

### 3. Закрашивание всей строки

Метод `highlight_completed_families` теперь:
- Закрашивает всю строку (все столбцы от A до Z), а не только конкретные ячейки
- Использует 26 столбцов (A-Z) для полного охвата строки
- Но благодаря улучшенной логике сопоставления закрашивает только правильные строки

### 4. Улучшенная логика в `highlight_family_in_sheet`

Аналогично `highlight_completed_families`, метод теперь:
- Более точно определяет местоположение имени в строке
- Закрашивает всю строку, но только для правильно идентифицированных семей

## Результат

- Устранена проблема с произвольным закрашиванием ячеек других семей
- Повышена точность сопоставления семей с записями в таблице
- Улучшена защита от ложных срабатываний на частичных совпадениях
- Теперь закрашивается вся строка семьи, как и ожидалось
- Сохранена обратная совместимость с существующим кодом

## Тестирование

Были созданы тесты, которые подтверждают корректность работы улучшенной логики сопоставления и защиты от ложных срабатываний.