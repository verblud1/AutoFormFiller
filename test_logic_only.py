#!/usr/bin/env python3
"""–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–∏–∫–∏ –ø–æ–∏—Å–∫–∞ –∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–µ–º–µ–π –±–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Google Sheets API"""

import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

def test_matching_logic():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –±–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API"""
    print("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–µ–º–µ–π...")
    
    # –ò–º–∏—Ç–∏—Ä—É–µ–º –∫–ª–∞—Å—Å —Å –Ω—É–∂–Ω—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏
    class TestMatcher:
        def _calculate_match_score(self, row_text: str, name: str) -> float:
            """
            –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–µ–ø–µ–Ω—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –º–µ–∂–¥—É —Ç–µ–∫—Å—Ç–æ–º —Å—Ç—Ä–æ–∫–∏ –∏ –∏–º–µ–Ω–µ–º
            """
            if not name or not row_text:
                return 0.0
            
            name_parts = [part for part in name.split() if len(part) > 2]  # –£–±–∏—Ä–∞–µ–º –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–æ–≤–∞
            if not name_parts:
                return 0.0
            
            matches = 0
            for part in name_parts:
                if part in row_text:
                    matches += 1
            
            # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è: —Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–µ–π –∏–º–µ–Ω–∏ –Ω–∞–π–¥–µ–Ω–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            score = matches / len(name_parts)
            
            # –ü–æ–≤—ã—à–∞–µ–º –æ—Ü–µ–Ω–∫—É, –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –±–æ–ª—å—à–µ –ø–æ–ª–æ–≤–∏–Ω—ã —á–∞—Å—Ç–µ–π –∏–º–µ–Ω–∏
            if matches == len(name_parts):
                score *= 1.2  # –ë–æ–Ω—É—Å –∑–∞ –ø–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
            
            return min(score, 1.0)  # –ù–µ –±–æ–ª—å—à–µ 1.0
        
        def _find_name_column_index(self, row: list, name: str) -> int:
            """–ù–∞—Ö–æ–¥–∏—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å —Å—Ç–æ–ª–±—Ü–∞, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∏–º—è"""
            name_parts = name.lower().split()
            
            # –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
            for j, cell in enumerate(row):
                cell_lower = cell.lower()
                if name.lower() in cell_lower:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –§–ò–û, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ —á–∞—Å—Ç–∏ —Å–ª–æ–≤–∞
                    if len(name_parts) > 1:  # –ï—Å–ª–∏ –≤ –∏–º–µ–Ω–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–µ–π (–§–ò–û)
                        for part in name_parts:
                            if len(part) > 2 and part in cell_lower:  # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —á–∞—Å—Ç–∏ –∏–º–µ–Ω–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –µ—Å—Ç—å –≤ —è—á–µ–π–∫–µ
                                return j + 1
                    else:
                        return j + 1
            
            # –ï—Å–ª–∏ –ø–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –∏—â–µ–º —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —á–∞—Å—Ç—è–º
            for j, cell in enumerate(row):
                cell_lower = cell.lower()
                matches = 0
                for part in name_parts:
                    if len(part) > 2 and part in cell_lower:
                        matches += 1
                # –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Ö–æ—Ç—è –±—ã 2 —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–∞–º–∏–ª–∏—è –∏ –∏–º—è), —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å—Ç–æ–ª–±—Ü–æ–º
                if matches >= 2:
                    return j + 1
            
            # –í –∫—Ä–∞–π–Ω–µ–º —Å–ª—É—á–∞–µ, –∏—â–µ–º —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
            for j, cell in enumerate(row):
                cell_lower = cell.lower()
                for part in name_parts:
                    if len(part) > 2 and part in cell_lower:
                        return j + 1
            
            return 1  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü
    
    matcher = TestMatcher()
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
    test_cases = [
        {
            'row_text': '–∏–≤–∞–Ω–æ–≤–∞ –∞–Ω–Ω–∞ –ø–µ—Ç—Ä–æ–≤–Ω–∞ –≥. –º–æ—Å–∫–≤–∞ —É–ª. –ª–µ–Ω–∏–Ω–∞ –¥. 5',
            'name': '–∏–≤–∞–Ω–æ–≤–∞ –∞–Ω–Ω–∞ –ø–µ—Ç—Ä–æ–≤–Ω–∞',
            'expected_min_score': 0.8
        },
        {
            'row_text': '—Å–º–∏—Ä–Ω–æ–≤ –≤–ª–∞–¥–∏–º–∏—Ä –∏–≤–∞–Ω–æ–≤–∏—á –≥. —Å–ø–± —É–ª. –ø—É—à–∫–∏–Ω–∞ –¥. 10',
            'name': '—Å–º–∏—Ä–Ω–æ–≤–∞ –æ–ª—å–≥–∞ –≤–ª–∞–¥–∏–º–∏—Ä–æ–≤–Ω–∞',
            'expected_min_score': 0.3  # –ë—É–¥–µ—Ç –º–µ–Ω—å—à–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥—Ä—É–≥–∞—è —Ñ–∞–º–∏–ª–∏—è
        },
        {
            'row_text': '–ø–µ—Ç—Ä–æ–≤–∞ –º–∞—Ä–∏—è —Å–µ—Ä–≥–µ–µ–≤–Ω–∞ –≥. –µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ —É–ª. –≥–∞–≥–∞—Ä–∏–Ω–∞ –¥. 15',
            'name': '–ø–µ—Ç—Ä–æ–≤–∞ –º–∞—Ä–∏—è —Å–µ—Ä–≥–µ–µ–≤–Ω–∞',
            'expected_min_score': 0.8
        }
    ]
    
    print("\nüìã –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è:")
    for i, test_case in enumerate(test_cases, 1):
        score = matcher._calculate_match_score(test_case['row_text'], test_case['name'])
        status = "‚úÖ" if score >= test_case['expected_min_score'] else "‚ö†Ô∏è "
        print(f"  –¢–µ—Å—Ç {i}: –æ—Ü–µ–Ω–∫–∞={score:.2f}, –æ–∂–∏–¥–∞–µ–º>={test_case['expected_min_score']} {status}")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ —Å—Ç–æ–ª–±—Ü–∞
    test_rows = [
        ["–ò–≤–∞–Ω–æ–≤–∞ –ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–Ω–∞", "–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 5", "3", "65.5", "–ø–æ–ª–Ω–∞—è"],
        ["–°–º–∏—Ä–Ω–æ–≤ –í–ª–∞–¥–∏–º–∏—Ä –ò–≤–∞–Ω–æ–≤–∏—á", "–≥. –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, —É–ª. –ü—É—à–∫–∏–Ω–∞, –¥. 10", "1", "45.2", "–Ω–µ–ø–æ–ª–Ω–∞—è"],
        ["–ü–µ—Ç—Ä–æ–≤–∞ –ú–∞—Ä–∏—è –°–µ—Ä–≥–µ–µ–≤–Ω–∞", "–≥. –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, —É–ª. –ì–∞–≥–∞—Ä–∏–Ω–∞, –¥. 15", "2", "52.3", "–ø–æ–ª–Ω–∞—è"]
    ]
    
    test_names = [
        "–ò–≤–∞–Ω–æ–≤–∞ –ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–Ω–∞",
        "–°–º–∏—Ä–Ω–æ–≤ –í–ª–∞–¥–∏–º–∏—Ä –ò–≤–∞–Ω–æ–≤–∏—á", 
        "–ü–µ—Ç—Ä–æ–≤–∞ –ú–∞—Ä–∏—è –°–µ—Ä–≥–µ–µ–≤–Ω–∞"
    ]
    
    print(f"\nüìã –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞ —Å—Ç–æ–ª–±—Ü–∞ —Å –∏–º–µ–Ω–µ–º:")
    for i, (row, name) in enumerate(zip(test_rows, test_names), 1):
        col_idx = matcher._find_name_column_index(row, name)
        status = "‚úÖ" if col_idx == 1 else "‚ö†Ô∏è "  # –û–∂–∏–¥–∞–µ–º, —á—Ç–æ –∏–º—è –±—É–¥–µ—Ç –≤ –ø–µ—Ä–≤–æ–º —Å—Ç–æ–ª–±—Ü–µ
        print(f"  –¢–µ—Å—Ç {i}: —Å—Ç–æ–ª–±–µ—Ü={col_idx}, –æ–∂–∏–¥–∞–µ–º=1 {status}")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∏—Ç—É–∞—Ü–∏—é —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –æ—à–∏–±–∫–æ–π - –∫–æ–≥–¥–∞ –∏–º—è –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤ –¥—Ä—É–≥–æ–π —è—á–µ–π–∫–µ
    print(f"\nüìã –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π:")
    tricky_row = ["–ò–≤–∞–Ω–æ–≤ –ü–µ—Ç—Ä", "–≥. –ú–æ—Å–∫–≤–∞", "–ò–≤–∞–Ω–æ–≤–∞ –ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–Ω–∞ - –º–∞—Ç—å", "3 —Ä–µ–±–µ–Ω–∫–∞"]
    col_idx = matcher._find_name_column_index(tricky_row, "–ò–≤–∞–Ω–æ–≤–∞ –ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–Ω–∞")
    score = matcher._calculate_match_score(' '.join(tricky_row).lower(), "–∏–≤–∞–Ω–æ–≤–∞ –∞–Ω–Ω–∞ –ø–µ—Ç—Ä–æ–≤–Ω–∞".lower())
    
    print(f"  –°–ª–æ–∂–Ω–∞—è —Å—Ç—Ä–æ–∫–∞: —Å—Ç–æ–ª–±–µ—Ü={col_idx}, –æ—Ü–µ–Ω–∫–∞={score:.2f}")
    if col_idx == 3:  # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è "–ò–≤–∞–Ω–æ–≤–∞ –ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–Ω–∞"
        print(f"  ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü —Å –∏–º–µ–Ω–µ–º –≤ –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω–æ–º —Ç–µ–∫—Å—Ç–µ")
    else:
        print(f"  ‚ö†Ô∏è  –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü (–æ–∂–∏–¥–∞–µ–º 3)")
    
    print("\n‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
    return True

def main():
    print("üî¨ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–∏—Å–∫–∞ –∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–µ–º–µ–π")
    print("="*60)
    
    success = test_matching_logic()
    
    print("="*60)
    if success:
        print("‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!")
        print("\nüìã –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç:")
        print("   ‚Ä¢ –ë–æ–ª–µ–µ —Ç–æ—á–Ω–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –§–ò–û —Å —è—á–µ–π–∫–∞–º–∏ —Ç–∞–±–ª–∏—Ü—ã")
        print("   ‚Ä¢ –ü–æ–≤—ã—à–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ –≤—Å–µ—Ö —á–∞—Å—Ç–µ–π –∏–º–µ–Ω–∏")
        print("   ‚Ä¢ –ë–æ–ª–µ–µ —Ç–æ—á–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ —Å –∏–º–µ–Ω–µ–º")
        print("   ‚Ä¢ –ó–∞—â–∏—Ç—É –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π –Ω–∞ —á–∞—Å—Ç–∏—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è—Ö")
        print("\nüí° –≠—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º –∑–∞–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ–º —è—á–µ–µ–∫")
        print("   –¥—Ä—É–≥–∏—Ö —Å–µ–º–µ–π –≤ Google Sheets.")
    else:
        print("‚ùå –¢–µ—Å—Ç—ã –ª–æ–≥–∏–∫–∏ –Ω–µ –ø—Ä–æ—à–ª–∏")
    
    return success

if __name__ == "__main__":
    main()